(self.webpackChunkkubevela_io=self.webpackChunkkubevela_io||[]).push([[94064],{3905:function(e,r,t){"use strict";t.d(r,{Zo:function(){return d},kt:function(){return m}});var n=t(67294);function o(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function a(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function i(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?a(Object(t),!0).forEach((function(r){o(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function s(e,r){if(null==e)return{};var t,n,o=function(e,r){if(null==e)return{};var t,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)t=a[n],r.indexOf(t)>=0||(o[t]=e[t]);return o}(e,r);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)t=a[n],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var l=n.createContext({}),u=function(e){var r=n.useContext(l),t=r;return e&&(t="function"==typeof e?e(r):i(i({},r),e)),t},d=function(e){var r=u(e.components);return n.createElement(l.Provider,{value:r},e.children)},p={inlineCode:"code",wrapper:function(e){var r=e.children;return n.createElement(n.Fragment,{},r)}},c=n.forwardRef((function(e,r){var t=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),c=u(t),m=o,f=c["".concat(l,".").concat(m)]||c[m]||p[m]||a;return t?n.createElement(f,i(i({ref:r},d),{},{components:t})):n.createElement(f,i({ref:r},d))}));function m(e,r){var t=arguments,o=r&&r.mdxType;if("string"==typeof e||o){var a=t.length,i=new Array(a);i[0]=c;var s={};for(var l in r)hasOwnProperty.call(r,l)&&(s[l]=r[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var u=2;u<a;u++)i[u]=t[u];return n.createElement.apply(null,i)}return n.createElement.apply(null,t)}c.displayName="MDXCreateElement"},32347:function(e,r,t){"use strict";t.r(r),t.d(r,{frontMatter:function(){return i},metadata:function(){return s},toc:function(){return l},default:function(){return d}});var n=t(22122),o=t(19756),a=(t(67294),t(3905)),i={title:"Generate top 50 popular resources of AWS using 100 lines of code",author:"Avery Qi (Tongji University) Zhengxi Zhou (Alibaba Cloud)",author_title:"KubeVela Team",author_url:"https://github.com/oam-dev/kubevela",author_image_url:"https://kubevela.io/img/logo.svg",tags:["Terraform"],description:"",hide_table_of_contents:!1},s={permalink:"/blog/2022/03/01/kubevela-generate-top-50-popular-resources-of-aws-using-100-lines-of-code",editUrl:"https://github.com/oam-dev/kubevela.io/tree/main/blog/2022-03-01-kubevela-generate-top-50-popular-resources-of-aws-using-100-lines-of-code.md",source:"@site/blog/2022-03-01-kubevela-generate-top-50-popular-resources-of-aws-using-100-lines-of-code.md",title:"Generate top 50 popular resources of AWS using 100 lines of code",description:"",date:"2022-03-01T00:00:00.000Z",formattedDate:"March 1, 2022",tags:[{label:"Terraform",permalink:"/blog/tags/terraform"}],readingTime:5.51,truncated:!1,prevItem:{title:"Machine Learning Practice with KubeVela",permalink:"/blog/2022/03/02/kubevela-with-machine-learning"},nextItem:{title:"KubeVela v1.2 - Focused on Developer Experience, Simplified Multi-Cluster Application Delivery",permalink:"/blog/2022/01/27/blog-1.2"}},l=[{value:"Where are the most popular cloud resources on AWS?",id:"where-are-the-most-popular-cloud-resources-on-aws",children:[]},{value:"Prerequisites",id:"prerequisites",children:[]},{value:"Executing the code",id:"executing-the-code",children:[]},{value:"Explanation for the code",id:"explanation-for-the-code",children:[{value:"Unmarshal the json data for the resources",id:"unmarshal-the-json-data-for-the-resources",children:[]},{value:"generating ComponentDefinitions in batch",id:"generating-componentdefinitions-in-batch",children:[]}]},{value:"Have a try?",id:"have-a-try",children:[]}],u={toc:l};function d(e){var r=e.components,t=(0,o.Z)(e,["components"]);return(0,a.kt)("wrapper",(0,n.Z)({},u,t,{components:r,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"KubeVela currently supports AWS, Azure, GCP,  AliCloud, Tencent Cloud, Baidu Cloud, UCloud and other cloud vendors, and also provides ",(0,a.kt)("a",{parentName:"p",href:"https://kubevela.io/docs/next/platform-engineers/components/component-terraform"},"a quick and easy command line tool")," to introduce cloud resources from cloud providers. But supporting cloud resources from cloud providers one by one in KubeVela is not conducive to quickly satisfying users' needs for cloud resources. This doc provides a solution to quickly introduce the top 50 most popular cloud resources from AWS in less than 100 lines of code."),(0,a.kt)("p",null,"We also expect users to be inspired by this article to contribute cloud resources for other cloud providers."),(0,a.kt)("h2",{id:"where-are-the-most-popular-cloud-resources-on-aws"},"Where are the most popular cloud resources on AWS?"),(0,a.kt)("p",null,"The official Terraform website provides Terraform modules for each cloud provider, for example, ",(0,a.kt)("a",{parentName:"p",href:"https://registry.terraform.io/namespaces/terraform-aws-modules"},"AWS cloud resource Terraform modules"),". And the cloud resources are sorted by popularity of usage (downloads), for example, AWS VPC has 18.7 million downloads."),(0,a.kt)("p",null,"Through a simple analysis, we found that the data for the top 50 popular Terraform modules for AWS can be obtained by requesting ",(0,a.kt)("a",{parentName:"p",href:"https://registry.terraform.io/v2/modules?filter%5Bprovider%5D=aws&include=latest-version&page%5Bsize%5D=50&page%5Bnumber%5D=1"},"https://registry.terraform.io/v2/modules?filter%5Bprovider%5D=aws&include=latest-version&page%5Bsize%5D=50&page%5Bnumber%5D=1"),"."),(0,a.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,a.kt)("p",null,"The code accepts two parameters."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"provider Name"),(0,a.kt)("li",{parentName:"ul"},"The URL of the Terraform Modules corresponding to the provider")),(0,a.kt)("p",null,"For AWS, Provider Name should be \u201caws\u201d\uff0ccorresponding Terraform modules URL is",(0,a.kt)("a",{parentName:"p",href:"https://registry.terraform.io/v2/modules?filter%5Bprovider%5D=aws&include=latest-version&page%5Bsize%5D=50&page%5Bnumber%5D=1"},"Terraform Modules json API"),"(Searching top 50 popular resources for provider aws in ",(0,a.kt)("a",{parentName:"p",href:"https://registry.terraform.io/"},"Terraform Registry"),")."),(0,a.kt)("p",null,"You need to make sure the providerName(aws) and Modules links are correct before executing the code."),(0,a.kt)("h2",{id:"executing-the-code"},"Executing the code"),(0,a.kt)("p",null,"Then you can quickly bring in the top 50 most popular AWS cloud resources in bulk with the following 100 lines of code (filename gen.go)."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'import (\n  "encoding/json"\n  "fmt"\n  "io"\n  "log"\n  "net/http"\n  "os"\n  "os/exec"\n  "path/filepath"\n  "strings"\n\n  "github.com/pkg/errors"\n)\n\ntype TFDownload struct {\n  Data     []DataItem     `json:"data"`\n  Included []IncludedItem `json:"included"`\n}\n\ntype IncludedItem struct {\n  Id         string     `json:"id"`\n  Attributes Attributes `json:"attributes"`\n}\n\ntype DataItem struct {\n  Attributes    Attributes    `json:"attributes"`\n  Relationships Relationships `json:"relationships"`\n}\n\ntype Relationships struct {\n  LatestVersion RelationshipLatestVersion `json:"latest-version"`\n}\n\ntype RelationshipLatestVersion struct {\n  Data RelationshipData `json:"data"`\n}\n\ntype RelationshipData struct {\n  Id string `json:"id"`\n}\n\nvar errNoVariables = errors.New("failed to find main.tf or variables.tf in Terraform configurations")\n\ntype Attributes struct {\n  Name        string `json:"name"`\n  Downloads   int    `json:"downloads"`\n  Source      string `json:"source"`\n  Description string `json:"description"`\n  Verified    bool   `json:"verified"`\n}\n\nfunc main() {\n  if len(os.Args) < 2 {\n     fmt.Println("Please provide the cloud provider name and an official Terraform modules URL")\n     os.Exit(1)\n  }\n  providerName := os.Args[1]\n  terraformModulesUrl := os.Args[2]\n  resp, err := http.Get(terraformModulesUrl)\n  if err != nil {\n     log.Fatal(err)\n  }\n  defer resp.Body.Close()\n  body, err := io.ReadAll(resp.Body)\n  if err != nil {\n     log.Fatal(err)\n  }\n\n  var modules TFDownload\n  if err := json.Unmarshal(body, &modules); err != nil {\n     fmt.Println(err.Error())\n     os.Exit(1)\n  }\n\n  if _, err = os.Stat(providerName); err == nil {\n     if err := os.RemoveAll(providerName); err != nil {\n        log.Fatal(err)\n     }\n     fmt.Printf("Successfully deleted existed directory %s\\n", providerName)\n  }\n  if _, err = os.Stat(providerName); os.IsNotExist(err) {\n     if err := os.Mkdir(providerName, 0755); err != nil {\n        if !os.IsExist(err) {\n           log.Fatal(err)\n        }\n        fmt.Printf("Successfully created directory %s\\n", providerName)\n     }\n  }\n\n  for _, module := range modules.Data {\n     var description string\n     for _, attr := range modules.Included {\n        if module.Relationships.LatestVersion.Data.Id == attr.Id {\n           description = attr.Attributes.Description\n        }\n     }\n     if description == "" {\n        description = strings.ToUpper(providerName) + " " + strings.Title(module.Attributes.Name)\n     }\n\n     outputFile := fmt.Sprintf("%s/terraform-%s-%s.yaml", providerName, providerName, module.Attributes.Name)\n     if _, err := os.Stat(outputFile); !os.IsNotExist(err) {\n        continue\n     }\n     if providerName == "aws" && (module.Attributes.Name == "rds" || module.Attributes.Name == "s3-bucket" ||\n        module.Attributes.Name == "subnet" || module.Attributes.Name == "vpc") {\n        continue\n     }\n     if err := generateDefinition(providerName, module.Attributes.Name, module.Attributes.Source, "", description); err != nil {\n        fmt.Println(err.Error())\n        os.Exit(1)\n     }\n  }\n}\n\nfunc generateDefinition(provider, name, gitURL, path, description string) error {\n  defYaml := filepath.Join(provider, fmt.Sprintf("terraform-%s-%s.yaml", provider, name))\n\n  cmd := fmt.Sprintf("vela def init %s --type component --provider %s --git %s.git --desc \\"%s\\" -o %s",\n     name, provider, gitURL, description, defYaml)\n  if path != "" {\n     cmd = fmt.Sprintf("%s --path %s", cmd, path)\n  }\n  fmt.Println(cmd)\n  stdout, err := exec.Command("bash", "-c", cmd).CombinedOutput()\n  if err != nil {\n     return errors.Wrap(err, string(stdout))\n  }\n  fmt.Println(string(stdout))\n  return nil\n}\n')),(0,a.kt)("p",null,"Executing the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'go run gen.go aws "https://registry.terraform.io/v2/modules?filter%5Bprovider%5D=aws&include=latest-version&page%5Bsize%5D=50&page%5Bnumber%5D=1"\n')),(0,a.kt)("h2",{id:"explanation-for-the-code"},"Explanation for the code"),(0,a.kt)("h3",{id:"unmarshal-the-json-data-for-the-resources"},"Unmarshal the json data for the resources"),(0,a.kt)("p",null,"Access the URL passed in by the user and parse the returned json data into the Go structure."),(0,a.kt)("p",null,"The json format corresponding to the resource is as follows."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'{\n  "data": [\n    {\n      "type": "modules",\n      "id": "23",\n      "attributes": {\n        "downloads": 18440513,\n        "full-name": "terraform-aws-modules/vpc/aws",\n        "name": "vpc",\n        "namespace": "terraform-aws-modules",\n        "owner-name": "",\n        "provider-logo-url": "/images/providers/aws.png",\n        "provider-name": "aws",\n        "source": "https://github.com/terraform-aws-modules/terraform-aws-vpc",\n        "verified": true\n      },\n      "relationships": {\n        "latest-version": {\n          "data": {\n            "id": "142143",\n            "type": "module-versions"\n          }\n        }\n      },\n      "links": {\n        "self": "/v2/modules/23"\n      }\n    },\n    ...\n  ],\n  "included": [\n    {\n      "type": "module-versions",\n      "id": "36806",\n      "attributes": {\n        "created-at": "2020-01-03T11:35:36Z",\n        "description": "Terraform module Terraform module for creating AWS IAM Roles with heredocs",\n        "downloads": 260030,\n        "published-at": "2020-02-06T06:26:08Z",\n        "source": "",\n        "tag": "v2.0.0",\n        "updated-at": "2022-02-22T00:45:44Z",\n        "version": "2.0.0"\n      },\n      "links": {\n        "self": "/v2/module-versions/36806"\n      }\n    },\n    ...\n  ],\n  ...\n}\n')),(0,a.kt)("p",null,"In the json data corresponding to Modules, we only care about two key-value pairs, viz."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"data: A list containing the names and properties of Modules"),(0,a.kt)("li",{parentName:"ul"},"Included: Information about the specific version of Modules filtered out")),(0,a.kt)("p",null,"In this case, for each Module element in data, resolve its attributes, Id and the id corresponding to the latest-version in relationship; for each Module version element in Included, resolve its attributes and Id."),(0,a.kt)("p",null,"The attributes are further resolved as follows five items: "),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Name"),(0,a.kt)("li",{parentName:"ul"},"Downloads"),(0,a.kt)("li",{parentName:"ul"},"Source"),(0,a.kt)("li",{parentName:"ul"},"Description"),(0,a.kt)("li",{parentName:"ul"},"Verified")),(0,a.kt)("p",null,"The Go structure is named as ",(0,a.kt)("inlineCode",{parentName:"p"},"TFDownload "),", The http library gets the json data and then parses the structure of the Terraform modules through the ",(0,a.kt)("inlineCode",{parentName:"p"},"json.Unmarshal"),"."),(0,a.kt)("h3",{id:"generating-componentdefinitions-in-batch"},"generating ComponentDefinitions in batch"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"creating directory and component definitions")),(0,a.kt)("p",null,"After parsing, create a new folder in the current directory and name the folder as \\<provider name",">","."),(0,a.kt)("p",null,"Iterate through the parsed data, and for each Module element, perform the following operations to generate the corresponding definition and documentation for it."),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"Generate definition files")),(0,a.kt)("p",null,"Generate the definition file by reading the corresponding information from the module's github repository using the following vela command."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"vela def init {ModuleName} --type component --provider {providerName} --git {gitURL} --desc {description} -o {yamlFileName}\n")),(0,a.kt)("p",null,"Several items to be filled in the instruction are passed in from the parsed Module structure."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"gitURL: \t{Module.Attributes.Source}.git"),(0,a.kt)("li",{parentName:"ul"},"description: If there are elements in ",(0,a.kt)("inlineCode",{parentName:"li"},"Included")," which have the same ID with relationship.latest-version.ID, set the description as the corresponding description in ",(0,a.kt)("inlineCode",{parentName:"li"},"Included")," elements, otherwise set the description as providerName+ModuleName. "),(0,a.kt)("li",{parentName:"ul"},"yamlFileName\uff1aterraform-{providerName}-{Module.Attributes.Name}.yaml")),(0,a.kt)("h2",{id:"have-a-try"},"Have a try?"),(0,a.kt)("p",null,"There are also a number of cloud providers that offer a wealth of Terraform modules, such as"),(0,a.kt)("p",null,"GCP: ",(0,a.kt)("a",{parentName:"p",href:"https://registry.terraform.io/namespaces/terraform-google-modules"},"https://registry.terraform.io/namespaces/terraform-google-modules")),(0,a.kt)("p",null,"Alibaba Cloud: ",(0,a.kt)("a",{parentName:"p",href:"https://registry.terraform.io/namespaces/terraform-alicloud-modules"},"https://registry.terraform.io/namespaces/terraform-alicloud-modules")),(0,a.kt)("p",null,"Do you want to extend cloud resources for your current or favorite cloud provider for KubeVela as well?"))}d.isMDXComponent=!0}}]);